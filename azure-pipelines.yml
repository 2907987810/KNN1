# Adapted from https://github.com/numba/numba/blob/master/azure-pipelines.yml
jobs:
# Mac and Linux could potentially use the same template
# except it isn't clear how to use a different build matrix
# for each, so for now they are separate
- template: ci/azure/macos.yml
  parameters:
    name: macOS
    vmImage: xcode9-macos10.13
- template: ci/azure/linux.yml
  parameters:
    name: Linux
    vmImage: ubuntu-16.04

# Windows Python 2.7 needs VC 9.0 installed, and not sure
# how to make that a conditional task, so for now these are
# separate templates as well
- template: ci/azure/windows.yml
  parameters:
    name: Windows
    vmImage: vs2017-win2016
- template: ci/azure/windows-py27.yml
  parameters:
    name: WindowsPy27
    vmImage: vs2017-win2016

- job: 'Checks_and_doc'
  pool:
    vmImage: ubuntu-16.04
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
      architecture: 'x64'

  - script: |
      sudo apt-get install -y libc6-dev-i386
      ci/incremental/install_miniconda.sh
      export PATH=$HOME/miniconda3/bin:$PATH
      export CONDA_ENV=pandas
      export ENV_FILE=ci/deps/azure-checks-and-doc.yaml
      ci/incremental/setup_conda_environment.sh
      conda env list
    displayName: 'Set up environment'

  - script: |
      export PATH=$HOME/miniconda3/bin:$PATH
      export CONDA_ENV=pandas
      ci/incremental/build.sh
    displayName: 'Build'
    condition: true

  - script: |
      export PATH=$HOME/miniconda3/bin:$PATH
      export AZURE=true
      ci/code_checks.sh lint
    displayName: 'Linting'
    condition: true

  - script: |
      export PATH=$HOME/miniconda3/bin:$PATH
      export AZURE=true
      ci/code_checks.sh patterns
    displayName: 'Looking for unwanted patterns'
    condition: true

  - script: |
      export PATH=$HOME/miniconda3/bin:$PATH
      ci/code_checks.sh doctests
    displayName: 'Running doctests'
    condition: true

  - script: |
      export PATH=$HOME/miniconda3/bin:$PATH
      ci/code_checks.sh docstrings
    displayName: 'Docstring validation'
    condition: true

  - script: |
      export PATH=$HOME/miniconda3/bin:$PATH
      source activate pandas
      doc/make.py html
    displayName: 'Building docs'
    condition: true

  - script: |
      export REPO_DIR="/tmp/pandas-docs-travis"
      git config --global user.email "pandas-docs-bot@localhost"
      git config --global user.name "pandas-docs-bot"
      # TODO PANDAS_GH_TOKEN needs to be added as a secret variable
      git clone "https://${PANDAS_GH_TOKEN}@github.com/pandas-dev/pandas-docs-travis.git" $REPO_DIR
      git branch gh-pages --track origin/gh-pages
      # TODO if this is the build from master, and not from a PR, the build should
      # be in the root replacing the old build, and not in a new directory
      cp -r doc/build/html $REPO_DIR/$(System.PullRequest.PullRequestId)
      cp LICENSE $REPO_DIR/$(System.PullRequest.PullRequestId)
      git add --all .
      git commit -m "Added pandas documentation of pull request $(System.PullRequest.PullRequestId)"
      git push
    displayName: 'Uploading docs'
    condition: true
